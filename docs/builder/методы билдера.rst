.. _`Черновики и конструктор черновиков (draftsbuilder)`: https://developer.kontur.ru/doc/extern.drafts
.. _`POST CreateDraftsBuilder`: https://developer.kontur.ru/doc/extern.drafts/method?type=post&path=%2Fv1%2F%7BaccountId%7D%2Fdrafts%2Fbuilders
.. _`GET GetDraftsBuilder`: https://developer.kontur.ru/doc/extern.drafts/method?type=get&path=%2Fv1%2F%7BaccountId%7D%2Fdrafts%2Fbuilders%2F%7BdraftsBuilderId%7D
.. _`GET GetDraftsBuilderMeta`: https://developer.kontur.ru/doc/extern.drafts/method?type=get&path=%2Fv1%2F%7BaccountId%7D%2Fdrafts%2Fbuilders%2F%7BdraftsBuilderId%7D%2Fmeta
.. _`PUT UpdateDraftsBuilder`: https://developer.kontur.ru/doc/extern.drafts/method?type=put&path=%2Fv1%2F%7BaccountId%7D%2Fdrafts%2Fbuilders%2F%7BdraftsBuilderId%7D
.. _`PUT UpdateDraftsBuilderMeta`: https://developer.kontur.ru/doc/extern.drafts/method?type=put&path=%2Fv1%2F%7BaccountId%7D%2Fdrafts%2Fbuilders%2F%7BdraftsBuilderId%7D%2Fmeta
.. _`POST BuildDrafts`: https://developer.kontur.ru/doc/extern.drafts/method?type=post&path=%2Fv1%2F%7BaccountId%7D%2Fdrafts%2Fbuilders%2F%7BdraftsBuilderId%7D%2Fbuild
.. _`GET GetBuildResult`: https://developer.kontur.ru/doc/extern.drafts/method?type=get&path=%2Fv1%2F%7BaccountId%7D%2Fdrafts%2Fbuilders%2F%7BdraftsBuilderId%7D%2Ftasks%2F%7BapiTaskId%7D
.. _`DELETE RemoveDraftsBuilder`: https://developer.kontur.ru/doc/extern.drafts/method?type=delete&path=%2Fv1%2F%7BaccountId%7D%2Fdrafts%2Fbuilders%2F%7BdraftsBuilderId%7D
.. _`GET GetDraftsBuilderDocuments`: https://developer.kontur.ru/doc/extern.drafts/method?type=get&path=%2Fv1%2F%7BaccountId%7D%2Fdrafts%2Fbuilders%2F%7BdraftsBuilderId%7D%2Fdocuments
.. _`POST CreateDraftsBuilderDocument`: https://developer.kontur.ru/doc/extern.drafts/method?type=post&path=%2Fv1%2F%7BaccountId%7D%2Fdrafts%2Fbuilders%2F%7BdraftsBuilderId%7D%2Fdocuments
.. _`GET GetDraftsBuilderDocument`: https://developer.kontur.ru/doc/extern.drafts/method?type=get&path=%2Fv1%2F%7BaccountId%7D%2Fdrafts%2Fbuilders%2F%7BdraftsBuilderId%7D%2Fdocuments%2F%7BdocumentId%7D
.. _`GET GetDraftsBuilderDocumentMeta`: https://developer.kontur.ru/doc/extern.drafts/method?type=get&path=%2Fv1%2F%7BaccountId%7D%2Fdrafts%2Fbuilders%2F%7BdraftsBuilderId%7D%2Fdocuments%2F%7BdocumentId%7D%2Fmeta
.. _`PUT UpdateDraftsBuilderDocument`: https://developer.kontur.ru/doc/extern.drafts/method?type=put&path=%2Fv1%2F%7BaccountId%7D%2Fdrafts%2Fbuilders%2F%7BdraftsBuilderId%7D%2Fdocuments%2F%7BdocumentId%7D
.. _`PUT UpdateDraftsBuilderDocumentMeta`: https://developer.kontur.ru/doc/extern.drafts/method?type=put&path=%2Fv1%2F%7BaccountId%7D%2Fdrafts%2Fbuilders%2F%7BdraftsBuilderId%7D%2Fdocuments%2F%7BdocumentId%7D%2Fmeta
.. _`DELETE RemoveDraftsBuilderDocument`: https://developer.kontur.ru/doc/extern.drafts/method?type=delete&path=%2Fv1%2F%7BaccountId%7D%2Fdrafts%2Fbuilders%2F%7BdraftsBuilderId%7D%2Fdocuments%2F%7BdocumentId%7D
.. _`GET GetDraftsBuilderDocumentFiles`: https://developer.kontur.ru/doc/extern.drafts/method?type=get&path=%2Fv1%2F%7BaccountId%7D%2Fdrafts%2Fbuilders%2F%7BdraftsBuilderId%7D%2Fdocuments%2F%7BdocumentId%7D%2Ffiles
.. _`POST CreateDraftsBuilderDocumentFile`: https://developer.kontur.ru/doc/extern.drafts/method?type=post&path=%2Fv1%2F%7BaccountId%7D%2Fdrafts%2Fbuilders%2F%7BdraftsBuilderId%7D%2Fdocuments%2F%7BdocumentId%7D%2Ffiles
.. _`GET GetDraftsBuilderDocumentFile`: https://developer.kontur.ru/doc/extern.drafts/method?type=get&path=%2Fv1%2F%7BaccountId%7D%2Fdrafts%2Fbuilders%2F%7BdraftsBuilderId%7D%2Fdocuments%2F%7BdocumentId%7D%2Ffiles%2F%7BfileId%7D
.. _`PUT UpdateDraftsBuilderDocumentFile`: https://developer.kontur.ru/doc/extern.drafts/method?type=put&path=%2Fv1%2F%7BaccountId%7D%2Fdrafts%2Fbuilders%2F%7BdraftsBuilderId%7D%2Fdocuments%2F%7BdocumentId%7D%2Ffiles%2F%7BfileId%7D
.. _`GET GetDraftsBuilderDocumentFileContent`: https://developer.kontur.ru/doc/extern.drafts/method?type=get&path=%2Fv1%2F%7BaccountId%7D%2Fdrafts%2Fbuilders%2F%7BdraftsBuilderId%7D%2Fdocuments%2F%7BdocumentId%7D%2Ffiles%2F%7BfileId%7D%2Fcontent
.. _`GET GetDraftsBuilderDocumentFileSignatureContent`: https://developer.kontur.ru/doc/extern.drafts/method?type=get&path=%2Fv1%2F%7BaccountId%7D%2Fdrafts%2Fbuilders%2F%7BdraftsBuilderId%7D%2Fdocuments%2F%7BdocumentId%7D%2Ffiles%2F%7BfileId%7D%2Fsignature
.. _`GET GetDraftsBuilderDocumentFileMeta`: https://developer.kontur.ru/doc/extern.drafts/method?type=get&path=%2Fv1%2F%7BaccountId%7D%2Fdrafts%2Fbuilders%2F%7BdraftsBuilderId%7D%2Fdocuments%2F%7BdocumentId%7D%2Ffiles%2F%7BfileId%7D%2Fmeta
.. _`PUT UpdateDraftsBuilderDocumentFileMeta`: https://developer.kontur.ru/doc/extern.drafts/method?type=put&path=%2Fv1%2F%7BaccountId%7D%2Fdrafts%2Fbuilders%2F%7BdraftsBuilderId%7D%2Fdocuments%2F%7BdocumentId%7D%2Ffiles%2F%7BfileId%7D%2Fmeta
.. _`DELETE RemoveDraftsBuilderDocumentFile`: https://developer.kontur.ru/doc/extern.drafts/method?type=delete&path=%2Fv1%2F%7BaccountId%7D%2Fdrafts%2Fbuilders%2F%7BdraftsBuilderId%7D%2Fdocuments%2F%7BdocumentId%7D%2Ffiles%2F%7BfileId%7D
.. _`формату`: https://normativ.kontur.ru/document?moduleId=8&documentId=335100

Методы для работы с DraftsBuilder
=================================

Подробная спецификация методов показана в Swagger в разделе `Черновики и конструктор черновиков (draftsbuilder)`_.

.. contents:: Список доступных методов
   :depth: 2

.. _rst-markup-createDB:

Создание DraftsBuilder
----------------------

Метод: `POST CreateDraftsBuilder`_

Метод создает шаблон черновика. В результате метод вернет идентификатор созданного шаблона DraftsBuilder и все его содержимое. 

**Параметры Тела запроса** 

* ``sender`` — информация об отправителе;
* ``payer`` — информация о налогоплательщике, организации, за которую отправляется отчет;
* ``recipient`` — информация о получателе отчетности, налоговом органе;
* ``builder-type`` — :doc:`тип DraftsBuilder</specification/типы DraftsBuilder>`;
* ``builder-data``  — данные для указанного типа DraftsBuilder. Состав полей будет отличаться для каждого типа DraftsBuilder. 

   Параметры Builder-data в зависимости от типа DraftsBuilder:

   .. tabs::

      .. tab:: тип fns534-inventory

         Тип DraftsBuilder fns534-inventory предназначен для формирования черновика описи, чтобы отправить в ИФНС запрошенные документы к входящему требованию или поясняющие документы к отправленному отчету.

            Если входящее требование было получено (или исходный отчет был отправлен) через Контур.Экстерн или API, то заполнению подлежит только параметр ``related-document``. Впоследствии черновик описи (ответа на требование), который будет сформирован при помощи DraftBuilder, после отправки превратится в документооборот с типом urn:docflow:fns534-inventory. 
            
            Если исходный отчет отправлен через стороннего оператора ЭДО — то заполнению подлежит только параметр ``id-file-osn``. Впоследствии черновик описи, который будет сформирован при помощи DraftBuilder, после отправки превратится в документооборот с типом urn:docflow:fns534-submission.

         * ``related-document`` — связанный документ (требование или отчет), отправленный через Контур.Экстерн (или API), на который формируется опись:
            
            * ``related-docflow-id`` — идентификатор связанного документооборота;
            * ``related-document-id`` — идентификатор документа в связанном документообороте.
         
         * ``id-file-osn`` — идентификатор файла основания — отчета, отправленного через другого оператора ЭДО. Нужно передать значение поля ИдФайл из xml-файла отчета. Данный идентификатор будет подставлен в поле ИдФайлОсн описи. Например, для отчета НДС поле ИдФайл = "NO_NDS_0007_0007_7381415822111135111_20180810_d229fcba-3747-4ce0-bb6d-7a2f220b07da". 

         :download:`пример Request Body для создания DraftsBuilder Ответа на требование<../files/мета для создания DraftsBuilder типа inventory.json>`

      .. tab:: тип business-registration

         * ``registration-info`` — сведения для регистрации бизнеса:
            
            * ``application-code`` — код заявления по справочнику СФРД. Enums:
               
               * **Р24001** — Заявление о внесении изменений в сведения об индивидуальном предпринимателе, содержащиеся в ЕГРИП;
               * **Р24002** — Заявление об изменении сведений о крестьянском (фермерском) хозяйстве в ЕГРИП;
               * **Р26001** — Заявление о государственной регистрации прекращения физическим лицом деятельности в качестве индивидуального предпринимателя в связи с принятием им решения о прекращении данной деятельности;
               * **Р11001** — Заявление о государственной регистрации юридического лица; 
               * **Р12001** — Заявление о регистрации юридического лица при реорганизации;
               * **Р12003** — Уведомление о начале реорганизации;
               * **Р16002** — Заявление о ликвидации унитарного предприятия в связи с продажей его имущества.
               * **Р26002** — Заявление о ликвидации крестьянского (фермерского) хозяйства;

            * ``applicant-infos`` — информация о заявителе;
            * ``business-type`` — тип регистрируемого бизнеса. Enums: **ip, ul**;
            * ``ip-info`` — информация об ИП;

               * ``ogrn-ip`` — ОГРНИП. 

            * ``ul-info`` — информация о ЮЛ:

               * ``ogrn`` — ОГРН.
               * ``name`` — название организации

         * ``paper-documents-delivery-type`` — признак наличия запроса о предоставлении документов отправителю в письменном (бумажном) виде. Enums:

            * **ToApplicant** — выдать документы лично заявителю;
            * **ByPost** — выслать документы по почте;
            * **No** — если не требуется предоставления документов в письменном (бумажном) виде.

         * ``additional-certificates`` — список сертификатов подписантов, когда заявление подано от нескольких заявителей (для ЮЛ). Сертификат должен быть передан в формате base64. 

         :download:`пример Request Body для создания DraftsBuilder для регистрации бизнеса <../files/мета для создания DraftsBuilder типа business-registration.json>`

      .. tab:: тип pfr-report

           Для DraftsBuilder типа pfr-report параметр builder-data не передается. 
         
         :download:`пример Request Body для создания DraftsBuilder для отчета в ПФР <../files/мета для создания DraftsBuilder типа pfr-report.json>`

Получение DraftsBuilder
-----------------------

Метод: `GET GetDraftsBuilder`_

При помощи данного метода можно просмотреть содержимое созданного DraftsBuilder. Метод вернет метаинформацию и текущий статус DraftsBuilder (new, building, finished).

Получение метаинформации DraftsBuilder
---------------------------------------

Метод: `GET GetDraftsBuilderMeta`_

Метод возвращает только метаинформацию DraftsBuilder без статуса.

Редактирование DraftsBuilder
----------------------------

Метод: `PUT UpdateDraftsBuilder`_

Метод обновляет DraftsBuilder и его метаинформацию на переданные в запросе. Если DraftsBuilder с переданным draftsBuilderId не найден, метод создаст его. 

Редактирование метаинформации DraftsBuilder
--------------------------------------------

Метод: `PUT UpdateDraftsBuilderMeta`_

Метод обновляет метаинформацию DraftsBuilder.

.. _rst-markup-buildDB:

Сборка содержимого DraftsBuilder в черновик
-------------------------------------------

Метод: `POST BuildDrafts`_

Чтобы завершить создание черновика описи необходимо привести все переданные данные к установленному формату. Сборку черновиков нужно запускать, когда пользователь добавил все файлы документов, необходимые для отправки отчета в налоговый орган. Если после сборки доложить в черновик новый документ, файл описи станет недействительным. 

В результате работы метод вернет:

* идентификаторы черновиков, в каждом из которых будет находиться: xml-файл описи, файлы, сообщение о представительстве (если есть);
* информацию о выполнении сборки, которая содержит: идентификатор TaskId, состояние сборки, результат, сообщение об ошибке. 

Когда запускается сборка DraftsBuilder, на него ставится :doc:`блокировка</knowledge base/loks>`. После успешного завершения сборки нельзя вносить изменения в DraftBuilder. Если необходимо повторно загрузить документы, нужно создать и наполнить новый DraftBuilder. 

.. important:: Во время сборки документы проходят проверки. Если документы в билдере не корректные, то это не будет являться ошибкой сборки, метод вернет ответ ``200 OK``. Документы с ошибками будут перечислены в модели ``error-drafts-builder-documents``. Данные документы необходимо исправить, повторно создать DraftBuilder, загрузить исправленные файлы и повторить сборку. Если хотя бы один документ корректный — будет создан черновик. 

Время сборки зависит от количества и размера файлов. Отследить состояние сборки черновиков можно при помощи метода GetBuildResult по полученному идентификатору задачи TaskId и идентификатору DraftsBuilderId.

Проверка статуса сборки
-----------------------

Метод: `GET GetBuildResult`_

По переданным идентификаторам TaskId и DraftsBuilderId метод возвращает статус сборки. Когда сборка завершится, значение статуса будет succeed. Если хотя бы в одном документе произошла ошибка, статус сборки вернется также со значением succeed, а документ будет записан в список ошибочных (error-drafts-builder-documents). Идентификаторы сформированных без ошибок черновиков будут в списке draft-ids.

Удаление DraftsBuilder
----------------------

Метод: `DELETE RemoveDraftsBuilder`_

Метод удаляет DraftsBuilder и все его содержимое.

------------

Методы для работы с документами DraftsBuilder
=============================================

Получение списка документов
---------------------------

Метод: `GET GetDraftsBuilderDocuments`_

По идентификатору DraftsBuilderId метод находит список созданных в нем документов, для каждого возвращается: идентификатор документа, идентификатор DraftsBuilder, метаинформация.

.. _rst-markup-createdocDB:

Создание документа
------------------

Метод: `POST CreateDraftsBuilderDocument`_

Чтобы добавить файлы, необходимо сначала добавить для них контейнер — документ. Вызываем столько раз, сколько отдельных документов-контейнеров нужно создать.

**Параметры Тела запроса (Request Body)**

* ``builder-data`` — данные для указанного типа DraftsBuilder. Состав полей будет отличаться для каждого типа DraftsBuilder. 

   Параметры Builder-data в зависимости от типа DraftsBuilder:

   .. tabs::

      .. tab:: тип fns534-inventory

         * ``claim-item-number`` — номер пункта требования, под которым документ указан в требовании в виде 1.ХХ или 2.ХХ;
         * ``label-for-grouping`` — метка группы документов для разделения по разным описям. 
            
            Иногда ФНС просит, чтобы налогоплательщик прислал определенные документы в разных описях. По данной метке документы будут разделены в разные черновики с разными файлами описи. В параметре можно передать любую строку, главное — для одной группы указывать одну и ту же строку. Значение null также является меткой. 
            
            **Пример**: для документа1 параметр не передан, для документа2 значение параметра "группа 1". Документы будут добавлены в разные черновики и будет сформировано две описи. Если параметр не передавать для всех документов, будет создан один черновик и один файл описи (:ref:`в соответствии с ограничениями на размер и количество файлов<rst-markup-db-restricting>`).

         * ``scanned-document-name`` — название отсканированного документа;
         * ``type`` — Тип документа. Enums: **formalized, scanned, warrant**;
         * ``background-processing`` — условия для немедленной обработки документа:

            * ``total-file-count`` — указание количества файлов в документе. Когда в документ будет добавлено указанное количество файлов, начнется обработка этого документа. Это позволяет перенести шаг подготовки документа на этап загрузки других документов, что существенно ускоряет сборку черновиков при большом количестве или размере файлов в документе.
            
               После начала обработки документ и его файлы будут заблокированы для изменений. 
            
               Рекомендуется выставлять, если клиент уверен, что документ уже не будет изменен до запуска сборки DraftsBuilder в черновики. Если хотя бы один документ был подготовлен с неправильными данными, то нужно будет пересоздать DraftsBuilder целиком.
         
         **Пример Request Body для создания документа**:

         .. code-block:: json

            {
               "builder-data": {
                  "claim-item-number": "1.00",
                  "label-for-grouping": null,
                  "scanned-document-name": "Имя документа.pdf",
                  "type": "scanned"
               }
            }

      .. tab:: тип business-registration

         * ``svdreg-code`` — код СВДРЕГ;
         * ``signers`` — данные каждого подписанта:

            * ``fio`` — ФИО каждого заявителя.

         **Пример Request Body для создания документа**:

         .. sourcecode:: json

            {
               "builder-data": {
                  "svdreg-code": "011011",
                  "signers": [
                     {
                     "fio": {
                        "surname": "Иванов",
                        "name": "Иван",
                        "patronymic": "Иванович"
                        }
                     }
                  ]
               }
            }

      .. tab:: тип pfr-report

         Для DraftsBuilder типа pfr-report параметр builder-data не передается. 

Получение информации о документе
--------------------------------

Метод: `GET GetDraftsBuilderDocument`_

Метод возвращает всю информацию о документе по его идентификатору.

Получение метаинформации документа
-----------------------------------

Метод: `GET GetDraftsBuilderDocumentMeta`_

Метод возвращает метаинформацию документа по его идентификатору. 

Редактирование документа
------------------------

Метод: `PUT UpdateDraftsBuilderDocument`_

Метод обновляет документ и его метаинформацию на переданные в запросе. Если документ с переданным documentId в DraftBuilder не найден, метод создаст его. 

Редактирование метаинформации документа
----------------------------------------

Метод: `PUT UpdateDraftsBuilderDocumentMeta`_

Метод обновляет метаинформацию документа.  

Удаление документа в DraftBuilder
---------------------------------

Метод: `DELETE RemoveDraftsBuilderDocument`_

Удаляет документ по его идентификатору в заданном DraftBuilder.

-------

Методы для работы с файлами
===========================

Получение списка всех файлов документа
--------------------------------------

Метод: `GET GetDraftsBuilderDocumentFiles`_

По идентификатору DraftsBuilder и документу в нем метод находит список добавленных файлов.

.. _rst-markup-createfileDB:

Создание файла в документе
--------------------------

Метод: `POST CreateDraftsBuilderDocumentFile`_

Метод создает файл в документе. Вызываем столько раз, сколько файлов нужно положить в документ-контейнер.

**Параметры Тела запроса (Request Body)**:

* ``content-id`` — идентификатор контента в сервисе контентов;
* ``base64-signature-content`` — контент подписи файла в формате base64;
* ``meta`` — метаинформация файла:

   * ``file-name`` — полное имя файла;

      Для файла доверенности, который прилагается к банковской гарантии, имя должно соответствовать `формату`_ (см. Сведения об уполномоченном представителе Банка (Гаранта) (СвПред). Имя файла документа, подтверждающего полномочия представителя). Иначе метод вернет ошибку 400.  

   * ``builder-data`` — данные для указанного типа DraftsBuilder. Состав полей будет отличаться для каждого типа DraftsBuilder.

      Параметры builder-data в зависимости от типа DraftsBuilder:

      .. tabs::

         .. tab:: тип fns534-inventory

            ``scanned-file-order`` — порядковый номер файла в многостраничном документе. Если документ одностраничный, то файл будет один и передавать в параметре "1" не обязательно. Пример использования параметра: "3" будет означать, что данный файл — третья страница в документе.

            **Пример Request Body для создания файла**:

            .. code-block:: json

               {
                  "content-id": "1fa932c7-84c2-4f20-acc5-56917ba85aaa",
                  "base64-signature-content": "MIINFQYJKoZIhvcNAQcCoIINBjCCDQI...u5yhEBC9oMu/oLG0hL66DVA/09vGdg=",
                  "meta": {
                     "file-name": "Имя документа.pdf",
                     "builder-data": {
                        "scanned-file-order": "3"
                     }
                  }
               }

         .. tab:: тип business-registration

            Для DraftsBuilder типа business-registration параметр builder-data не передается. 

            **Пример Request Body для создания файла**:

            .. code-block:: json

               {
                  "content-id": "1fa932c7-84c2-4f20-acc5-56917ba85aaa",
                  "base64-signature-content": "MIINFQYJKoZIhvcNAQcCoIINBjCCDQI...u5yhEBC9oMu/oLG0hL66DVA/09vGdg=",
                  "meta": {
                     "file-name": "AnyFileName.pdf",
                     "builder-data": null
                  }
               }

         .. tab:: тип pfr-report

            Для DraftsBuilder типа pfr-report параметр builder-data не передается.

            **Пример Request Body для создания файла**:

            .. code-block:: json

               {
                  "content-id": "1fa932c7-84c2-4f20-acc5-56917ba85aaa",
                  "base64-signature-content": "MIINFQYJKoZIhvcNAQcCoIINBjCCDQI...u5yhEBC9oMu/oLG0hL66DVA/09vGdg=",
                  "meta": {
                     "file-name": "AnyFileName.pdf",
                     "builder-data": null
                  }
               }


Получение файла по идентификатору
---------------------------------

Метод: `GET GetDraftsBuilderDocumentFile`_

Метод возвращает всю информацию о файле по его идентификатору.

Редактирование файла в документе
--------------------------------

Метод: `PUT UpdateDraftsBuilderDocumentFile`_

Метод обновляет файл и подпись в документе на переданные в запросе. Если файл с переданным fileId в документе не найден, метод создаст его. 

Получение подписи к файлу
-------------------------

Метод: `GET GetDraftsBuilderDocumentFileSignatureContent`_

Метод возвращает подпись контрагента, если она была приложена к файлу, в формате base64.

Получение метаинформации файла
------------------------------

Метод: `GET GetDraftsBuilderDocumentFileMeta`_

Метод возвращает метаинформацию файла.

Редактирование меты файла
-------------------------

Метод: `PUT UpdateDraftsBuilderDocumentFileMeta`_

Метод обновляет метаинформацию файла.

Удаление файла документа
------------------------

Метод: `DELETE RemoveDraftsBuilderDocumentFile`_

Метод удаляет файл в документе DraftsBilder по его идентификатору. 

Получение содержимого файла (deprecated)
----------------------------------------

Метод: `GET GetDraftsBuilderDocumentFileContent`_

.. attention:: **Метод устарел.** Вместо него используйте :doc:`Сервис контентов</knowledge base/content>`. Идентификатор контента лежит в параметре content-id.

Метод возвращает содержимое файла в формате base64. Максимальный размер возвращаемого контента 32 МБ для тестовой и 64 МБ для рабочей площадки.
