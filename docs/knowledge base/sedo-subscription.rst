.. _`сайте ФСС`: https://sedo.fss.ru/sedo.html
.. _`POST Draft`: https://developer.kontur.ru/doc/extern/method?type=post&path=%2Fv1%2F%7BaccountId%7D%2Fdrafts
.. _`GET Download`: https://developer.kontur.ru/doc/extern/method?type=get&path=%2Fv1%2F%7BaccountId%7D%2Fcontents%2F%7Bid%7D
.. _`POST AddSignature`: https://developer.kontur.ru/doc/extern/method?type=post&path=%2Fv1%2F%7BaccountId%7D%2Fdrafts%2F%7BdraftId%7D%2Fdocuments%2F%7BdocumentId%7D%2Fsignatures
.. _`POST Check`: https://developer.kontur.ru/doc/extern/method?type=post&path=%2Fv1%2F%7BaccountId%7D%2Fdrafts%2F%7BdraftId%7D%2Fcheck
.. _`POST Prepare`: https://developer.kontur.ru/doc/extern/method?type=post&path=%2Fv1%2F%7BaccountId%7D%2Fdrafts%2F%7BdraftId%7D%2Fprepare
.. _`POST Send`: https://developer.kontur.ru/doc/extern/method?type=post&path=%2Fv1%2F%7BaccountId%7D%2Fdrafts%2F%7BdraftId%7D%2Fsend

Подписки СЭДО ФСС на получение извещений и уведомлений
======================================================

Есть три вида подписок, которые необходимо сделать для получения уведомлений и извещений от ФСС:

* Подписка оператора на организацию по РНС: urn:docflow:fss-sedo-provider-subscription.
* Подписка страхователя по РНС: urn:docflow:fss-sedo-abonent-subscription.
* Подписка страхователя по сотруднику: urn:docflow:fss-sedo-abonent-subscription.

Данные подписки также являются отдельными документооборотами. Процесс смены статусов документооборотов см. в разделе :ref:`спецификация<rst-markup_subscription>`.

.. warning:: Для получения извещений по ПВСО достаточно только подписки оператора на организацию по РНС. 

    Для получения уведомлений об электронных больничных необходима активная подписка оператора, а также подписка страхователя по РНС и по сотруднику. Помимо этого, для получения уведомлений по ЭЛН страхователю необходимо получить согласие от сотрудников и обратиться региональное отделение ФСС. 

    На `сайте ФСС`_ размещено типовое соглашение и согласие застрахованного лица на обработку персональных данных.

Создание и отправка подписок
----------------------------

**Алгоритм создания и отправки черновика подписок**

#. Создать черновик. Метод `POST Draft`_. В мета-информации черновика необходимо заполнить поле registration-number-fss — регистрационный номер, по которому производится подписка.
#. Создать документ в черновике по :doc:`json контракту</manuals/contracts>`. Метод :doc:`POST BuildDocumentContent</drafts/DraftDocumentBuildController>`. В ответе метод возвращает вместе с информацией о документе идентификатор контента для подписи в параметре data-to-sign-content-id.
#. Далее для подписок страхователя нужно добавить в документ подпись (подписка оператора на организацию по РНС подписания не требует): 

    1. Получить данные для подписи в сервисе контентов по идентификатору data-to-sign-content-id. Метод `GET Download`_.
    2. Подписать эти данные «сырой» (raw) подписью.
    3. Загрузить в черновик подпись `POST AddSignature`_.

#. Проверить черновик `POST Check`_. 
#. Подготовить черновик `POST Prepare`_.
#. Отправить черновик `POST Send`_.

После отправки подписки, ФСС пришлет результат. 

Получение результата подписки
-----------------------------

Получение документооборота подписки оператора
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

Для подписки оператора положительный результат от ФСС поступит в виде документа в отправленном документообороте. 

Для получения результата подписки оператора вам нужно найти документооборот и ожидать появления в нем результата подписки:

    1. Найти документооборот методом :ref:`GET Docflows<rst-markup-get-dcs>` с фильтром ``type=fss-sedo-provider-subscription``. 
    2. В полученной метаинформации документооборота в поле success-state будет отображаться статус подписки. Если подписка выполнена успешно, то статус будет ``successful``.

На этом документооборот завершится и подписка будет считаться выполненной.

Получение документооборота подписки страхователя
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

Результат подписки страхователя или ошибки, которые возникают в ходе подписки, ФСС присылает новым документооборотом. 

Чтобы получить результат подписок страхователя необходимо получить список документооборотов методом :ref:`GET Docflows<rst-markup-get-dcs>` с фильтром ``type=fss-sedo-abonent-subscription-result&type=fss-sedo-error``.

Данные документообороты содержат только идентификаторы для генерации запроса на получение документов. Никаких документов в рамках этого документооборота не приходит. Для получения результата страхователю необходимо сформировать запрос на получение документа, подписать его и направить в ФСС. 

.. note:: Документооборот с типом ``fss-sedo-error`` может приходить как на результат подписки, так и отдельно на другие типы документооборотов (получение извещений, уведомлений по ЭЛН). 

    Если ошибка связана с исходящим документооборотом подписки, то после запроса сообщения об ошибке, документ с ошибкой будет добавлен в исходный документооборот. В документооборот fss-sedo-error документ с ошибкой не запишется. 

**Как работать с запросом на получение документов** 

Если в процессе документооборота с ФСС необходимо сформировать запрос на получение документа, то нужно:

#. Создать запрос на получение документов от ФСС. Метод :ref:`POST GenerateDocumentsRequest<rst-murkup-sedo>`. В ответе метод возвращает шаблон запроса и данные для подписи.
#. Подписать данные для подписи, которые вернутся в параметре data-to-sign в формате byte[].
#. Добавить «сырую» (raw) подпись к запросу. Метод :ref:`PUT SaveDocumentsRequestSignature<rst-murkup-sedo>`.
#. Отправить запрос на получение документов в ФСС. Метод :ref:`POST SendDocumentsRequest<rst-murkup-sedo>`. При отправке запроса подпись будет встроена в шаблон.
#. После этого ФСС пришлет результат подписки или ошибку. Результаты подписки (документы) появятся и в исходном документообороте с отправленной подпиской.