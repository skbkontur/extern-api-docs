.. _`в справке`: https://www.diadoc.ru/docs/faq/faq-127
.. _`документы, представленные в виде скан-образа`: https://normativ.kontur.ru/document?moduleId=1&documentId=291280&rangeId=180910
.. _`справке`: https://www.diadoc.ru/docs/faq/faq-127

DraftsBuilder
=============

Что такое DraftsBuilder
-----------------------

DraftsBuilder — конструктор черновиков. Он помогает создать из переданных документов пользователя черновик.

DraftsBuilder можно использовать для получения черновиков следующих типов документооборотов:

* ответ на требование (urn:docflow:fns534-inventory);
* письмо в ФНС (urn:docflow:fns534-letter);
* регистрация бизнеса (urn:docflow:business-registration);
* отчетность в ПФР (urn:docflow:pfr-report).

Эти виды документооборотов отличаются большим количеством файлов, которые пользователи отправляют в контролирующие органы (далее — КО). Чаще всего такими файлами являются сканы документов. КО имеют требования к размеру, типу и количеству файлов в одном контейнере при работе с электронным документооборотом. DraftsBuilder упрощает процесс формирования черновика, помогает не нагружать излишней логикой системы пользователей и выполнять требования КО. 

**Функции DraftsBuilder:**

* приводит приложенные файлы к установленному КО формату;
* разбивает файлы на черновики;
* подкладывает в каждый черновик сообщение о представительстве, переданное налогоплательщиком;
* формирует XML-файл описи к каждому черновику;
* формирует XML-файл обращения для черновиков писем ФНС;
* задает документам уникальное название:

    * для документооборотов с ФНС все имена приложений и документов DraftsBuilder приводит к установленному ФНС формату и задает уникальный гуид;
    * для писем ФНС наименование каждого файла во вложении не должно превышать 100 символов. DraftsBuilder сократит название, если будет приложен файл с названием длиннее 100 символов;
    * для документооборота с ПФР DraftsBuilder переименует файл, если его имя не соответствует формату. 

Процесс работы с DraftsBuilder
------------------------------

.. image:: /_static/work_process_DB.png
    :width: 1000px
  

Процесс работы с DraftsBuilder сводится к трем шагам:

1. Создание DraftsBuilder — создается контейнер, который наполняется документами-контейнерами с файлами.
2. Наполнение контейнера —  в DraftsBuilder создаются документы, в которые загружаются файлы.
3. Запуск сборки черновика — контейнер преобразуется в черновик или набор черновиков.

Данные шаги определяют дальнейший алгоритм работы с методами. Каждый шаг имеет свои правила и логику. Чтобы понять их, сначала нужно разобраться в структуре DraftsBuilder и его сущностях. 

**Структура DraftsBuilder**

.. _rst-markup-db-restricting:

.. image:: /_static/structure_DB.png
    :width: 1000px

DraftsBuilder состоит из трех сущностей:

* **DraftsBuilder** — базовый контейнер, в который загружаются документы;
* **документ** — контейнер для файлов;
* **файл** — исходные файлы пользователя, которые он отправляет в КО в составе документа. Файлы могут быть формализованные и неформализованные, подробнее об этом читайте в `справке`_.

Налогоплательщики предоставляют в КО документы, которые могут состоять из нескольких файлов. В DraftsBuilder документ является контейнером для этих файлов. В один документ-контейнер можно положить:

* один или несколько файлов одного неформализованного документа;
* формализованный файл и подпись контрагента;
* титульные страницы формализованного документа с подписями контрагента.

.. note:: Существует два вида подписи:

              1. Подпись контрагента, она прикладывается к формализованным файлам.
              2. Подпись отправителя. 
    
        Подпись контрагента нужно подписывать КЭП отправителя описи, так же как и остальные файлы черновика перед отправкой.

Таким образом, DraftsBuilder будет содержать набор документов-контейнеров, которые при сборке преобразуются в один черновик или несколько, согласно ограничениям для файлов.

**Ограничения для файлов:**

* файлы должны быть с расширением: jpg, png, pdf, tif, tiff. Для писем возможен любой формат;
* можно приложить не больше 99 файлов;
* суммарный объем черновика может быть не более 60 Мб (для писем ФНС суммарный объем должен быть не более 5 Мб).

Для ответа на требования нужно приложить `документы, представленные в виде скан-образа`_ и указать номер приказа.

**Сборка контейнера в черновик**

При сборе DraftsBuilder преобразуется в черновик или несколько черновиков. Например, если суммарный объем приложенных файлов будет больше 60 МБ или пользователь приложит больше 99 файлов, то DraftsBuilder создаст несколько черновиков.

Каждый черновик будет отправлен как отдельный документооборот.


.. _rst-markup-invent-file:

 .. image:: /_static/assembly_DB.png
     :width: 1000px

Для некоторых документооборотов нужно соблюдать требования к составу отправляемых документов в КО. Для писем ФНС в составе должен быть файл обращения, для других документооборотов в составе должен быть файл описи.

**Файл обращения** в DraftsBuilder — это XML-файл с текстом обращения и сведениями о налогоплательщике. Формируется для писем ФНС (urn:docflow:fns534-letter). 

Ограничения по размеру: если текст обращения больше 1 Мб, то будет создано несколько черновиков. Один из черновиков будет содержать только файл обращения, который содержит в себе приложенный текст обращения. Другие черновики будут содержать файл обращения без текста и файлы приложений.

**Файл описи** в DraftsBuilder — это XML-файл с перечислением документов, которые налогоплательщик отправляет в КО. Это формализованный файл установленного формата. Формируется для следующих документооборотов:

* ответ на требования (urn:docflow:fns534-inventory);
* регистрация бизнеса (urn:docflow:business-registration);
* отчетность в ПФР (urn:docflow:pfr-report).

Особенности:

* для отчетности в ПФР формируется файл с датой и временем создания файла;
* для требований ФНС файл состоит из списка документов с привязкой пункта требования. В документах будут перечислены файлы для налогового органа и подписи.

.. important:: Во время сборки DraftsBuilder автоматически сформирует файлы описи и обращений на основании всех переданных документов.


.. _rst-markup-db-proc:
Алгоритм работы с DraftsBuilder в API
-------------------------------------


1. Создайте DraftsBuilder: :ref:`POST CreateDraftsBuilder<rst-markup-createDB>`.

 Метод создает шаблон черновика. В результате метод возвращает идентификатор созданного DraftsBuilder и все его содержимое.

 При создании DraftsBuilder укажите:

 * :doc:`тип DraftsBuilder</specification/типы DraftsBuilder>`;
 * флаг ``generate-warrant=true`` в параметре ``draft-options``, чтобы сформировать сообщение о представительстве на основании заполненных реквизитов в учетной записи Контур.Экстерн.

2. Добавьте документ: :ref:`POST CreateDraftsBuilderDocument<rst-markup-createdocDB>`.

 Чтобы добавить файлы, необходимо сначала добавить для них контейнер — документ. Вызывайте столько раз, сколько документов нужно передать.

3. Загрузите файлы в :ref:`Сервис контентов<rst-markup-load>`.

3. Добавьте файлы: :ref:`POST CreateDraftsBuilderDocumentFile<rst-markup-createfileDB>`.
 
 Метод создает файл в документе. Для этого укажите идентификатор контента из Сервиса контентов. Вызывайте столько раз, сколько файлов нужно положить в документ-контейнер.

4. Соберите DraftsBuilder в черновик: :ref:`POST BuildDrafts<rst-markup-buildDB>`.

 Метод собирает все добавленные файлы и документы DraftsBuilder шаблона в черновики. В результате метод вернет идентификаторы черновиков, в каждом из которых находится: XML-файл описи или XML-файл обращения, файлы, сообщение о представительстве (если есть).

Для редактирования содержимого DraftsBuilder смотрите описание :doc:`методов</builder/методы билдера>`. 

Чтобы предотвратить появление коллизий, в работе методов предусмотрены ограничения — :doc:`блокировки</knowledge base/loks>`.
