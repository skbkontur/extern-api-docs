.. _`Приказами ФНС от 13 июня 2013 г. N ММВ-7-6/196@`: https://normativ.kontur.ru/document?moduleId=1&documentId=338803
.. _`09.11.2010 N ММВ-7-6/535@`: https://normativ.kontur.ru/document?moduleId=1&documentId=371143&rangeId=401463#
.. _`ФЗ от 02.05.2006 N 59-ФЗ`: https://normativ.kontur.ru/document?moduleId=1&documentId=158860


Письма в ФНС
============

Отправка писем осуществляется в соответствии с `Приказами ФНС от 13 июня 2013 г. N ММВ-7-6/196@`_ и от `09.11.2010 N ММВ-7-6/535@`_. Согласно приказам для обмена письмами с ФНС с помощью электронного документооборота (ЭДО) нужно соблюдать требования:

* если письмо подписано уполномоченным представителем, то к письму нужно приложить доверенность или сообщение о представительстве;
* наименование каждого файла во вложении не должно превышать 100 символов;
* формат вложений может быть любым;
* отсканированные изображения должны быть черно-белыми, иметь разрешение не менее 150 и не более 300 точек на дюйм и использоваться 256 градаций серого цвета;
* к письму можно приложить не более 99 файлов;
* размер одного транспортного контейнера должен не превышать 5 Мб. В транспортный контейнер входят файлы с суммарным объемом не больше 4 Мб и служебные данные, которые формируются оператором ЭДО.

Порядок взаимодействия
----------------------

1. После отправки письма поступит документ *Подтверждение даты отправки*. Этот документ формируется оператором связи ЭДО, содержит данные о дате и времени отправки письма. Подтверждение даты отправки поступит каждому участнику документооборота: налогоплательщику и налоговому органу.

2. Когда письмо будет загружено в приемный комплекс ФНС, налогоплательщику поступит один из документов:

* *Извещение о получении*. Документ подтверждает факт получения письма налоговым органом. На этом документооборот не заканчивается. Необходимо дождаться результатов дальнейшей проверки письма ФНС.
* *Сообщение об ошибке*. Документ содержит информацию об ошибках. Документооборот на этом прекращается. Необходимо исправить указанные в сообщении ошибки и повторно отправить письмо.

3. ФНС регистрирует письмо и готовит на него ответ (если потребуется), либо формирует *Уведомление об отказе* с указанием причин отказа. Согласно `ФЗ от 02.05.2006 N 59-ФЗ`_ ответ от налогового органа на письмо, содержащий запрос, должен быть предоставлен в течение 30 дней со дня регистрации запроса в ФНС.

Работа с письмами ФНС в DraftsBuilder
-------------------------------------

Работа с письмами в API Контур.Экстерн состоит из двух этапов: создание черновика и работа с документооборотом. Черновик можно создать с помощью конструктора черновиков - :doc:`DraftsBuilder</knowledge base/DraftsBuilder>`. DraftsBuilder помогает облегчить подготовку черновика:

* приводит приложенные файлы к требованиям ФНС; 
* файлы в формате pdf, jpeg, tiff, png более 4 Мб делит на несколько черновиков. Но один файл другого формата должен быть не более 4 Мб; 
* если название файла длиннее 100 символом, то DraftsBuilder сократит название;
* подтягивает сообщение о представительстве из учетной записи в Контур.Экстрен при сборке черновика, либо позволяет загрузить доверенность самостоятельно в виде файла.

Для подготовки черновика в DraftsBuilder приложите текст сообщения в формате txt в кодировке Windows 1251 и файлы, которые планируете направить в ФНС. На основании приложенных файлов DraftsBuilder сформирует XML-файл обращения:

* текст обращения из txt-файла будет записан в блок @ОбращИнф → Текст сообщения;
* приложенные файлы будут перечислены в блоке @ОбращИнф/Прил.

Алгоритм работы с методами API
------------------------------

.. note:: Если все файлы приведены к нужному формату и есть файл обращения, то работу с черновиком можно начинать с 5 пункта.

1. Создайте DraftsBuilder:  :ref:`POST CreateDraftsBuilder<rst-markup-createDB>`. При создание DraftsBuilder укажите в теле запроса:

    * ``builder-type`` — :doc:`тип DraftsBuilder</specification/типы DraftsBuilder>`;
    * ``builder-data`` — ``region``.


    Для ответа на входящее письмо ФНС передайте в метаинформации следующие параметры:

    * ``related-docflow-id`` — идентификатор входящего документооборота;
    * ``related-document-id`` — идентификатор главного документа.

2. Добавьте документ: :ref:`POST CreateDraftsBuilderDocument<rst-markup-createdocDB>`.

3. Добавьте файл: :ref:`POST CreateDraftsBuilderDocumentFile<rst-markup-createfileDB>`.

4. Запустите сборку DraftsBuilder в черновик: :ref:`POST BuildDrafts<rst-markup-buildDB>`.

5. Подготовьте черновик к отправке с помощью методов для :ref:`работы с черновиком<rst-markup-drafts>`. 

6. Отслеживайте документооборот, ориентируясь на :ref:`статусы и порядок документооборота<rst-markup-spec-fns-letter>`.  