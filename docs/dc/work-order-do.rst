.. _rst-markup-do:

Порядок работы с документооборотами
===================================

Документооборот (ДО) — обмен юридически значимыми документами между организацией и контролирующим органом.

Документооборот характеризуют:

* тип. Он зависит от отчета, который нужно отправить в контролирующий орган. Все типы ДО перечислены в :doc:`спецификации</specification/типы ДО>`; 
* категория. Существует две категории:

    * исходящие документообороты — те, которые отправила организация в сторону контролирующего органа;
    * входящие документообороты — те, которые отправил контролирующий орган в сторону организации.

* статус. Для каждого типа ДО смена статусов от Отправлен до Завершен может быть разной и зависит от входящих и ответных документов. Схемы смены статусов можно посмотреть в :doc:`спецификации</specification/статусы ДО>`. 

Документооборот наполнен документами разных видов: отправленный отчет, который был подготовлен организацией с черновиком, входящие технологические документы, которые присылает контролирующий орган и ответные документы, которые отправляет организация в ответ на входящие по порядку взаимодействия с контролирующим органом. 

**Особенности работы с документооборотом**

* Входящий ДО может возникнуть в любой момент, и о нем можно узнать только при запросе списка всех документооборотов.
* Смена статусов ДО происходит при получении входящих документов или при отправке ответных документов.
* В метаинформации документооборота постепенно после отправки ДО появляются ссылки разных типов. На все ссылки с типом ``reply`` необходимо сформировать и отправить ответные документы.
* У некоторых входящих ДО существует жесткий регламент сроков отправки ответных документов. Например, при получении входящего требования ФНС есть 6 дней для формирования ответных документов. В противном случае последуют административные санкции к организации.
* На некоторые входящие ДО нужно формировать новые исходящие ДО. Например, в ответ на требование зачастую необходимо отправить в ФНС документы. Входящее письмо от КО нередко требует формирование ответного исходящего письма.  

Алгоритм работы с документооборотом
-----------------------------------

При работе с отчетностью и требованиями на некоторые входящие документы нужно отправлять ответные. Формат и сроки ответа регламентированы разными нормативными актами контролирующих органов. 

Входящие документы появляются в документообороте в  зависимости от статуса ДО. По мере поступления входящих документов, в метаинформации появляются ссылки на формирование и отправку ответных документов с помощью API Контур.Экстерн.

Рекомендуем следовать следующему порядку работы с ДО:

1. Проверьте статус ДО.
2. Получите входящие документов от КО.
3. Отправьте ответные документы. 

.. image:: /_static/Алгоритм_работы_с_ДО.png

Проверка статуса документооборота
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

Чтобы узнать статус документооборота запросите список ДО своей учетной записи: :ref:`GET Docflows<rst-markup-get-dcs>`. Для каждого документооборота в параметре ``status`` вернется актуальный статус на текущий момент. 

Получение входящих документов от контролирующего органа
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

Все входящие документы, которые появляются в документообороте, автоматически загружаются в :ref:`Сервис контентов<rst-markup-content>`, и им присваивается идентификатор ``content-id``. При запросе документооборота мы возвращаем этот идентификатор для каждого документа в модели ``docflow-document-contents``. По этому идентификатору можно скачать документ из Сервиса контентов.

Контролирующий орган, как правило, присылает документы зашифрованными и сжатыми. Для получения документа в расшифрованном и разжатом виде нужно:

1. Запросите документооборот по его идентификатору ``content-id``: :ref:`GET Docflow<rst-markup-get-dc>`. В ответ метод вернет модель ``documents``, в которой указан идентификатор ``documentId`` документа. Также ответе необходимо посмотреть значения полей в параметре ``docflow-document-contents``:

    * ``content-id`` — идентификатор, по которому можно скачать контент в Сервисе контентов;
    * ``encrypted`` — признак, что контент зашифрован; 
    * ``compressed`` — признак, что контент сжат.

2. Получите контент файла по его идентификатору в :ref:`Сервисе контентов<rst-markup-content>`.
3. Расшифруйте документ, если нужно. В параметре ``encrypted-certificates`` перечислены сертификаты, на которые контролирующий орган зашифровал отправленный документ.
4. Распакуйте архив с полученным документом, если нужно. 

Далее нужно сформировать ответные документы согласно порядку работы с документооборотом.

.. note:: Для некоторых типов документооборот порядок получение входящих документов от контролирующего органа отличается, например, для :doc:`проактивных выплат</scenarios/SFR/FSS/index>`. 

Создание и отправка ответных документов
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

Формирование ответного документа похоже на создание черновика. Только API самостоятельно сгенерирует файл ответного документа на основании других документов ДО:

1. Создайте ответный документ (можно по ссылке типа reply): :ref:`POST CreateReplyDocument<rst-markup-CreateReplyDocument>`. Либо запросите документооборот методом :ref:`GET Docflow<rst-markup-get-dc>` и создайте ответный документ по ссылке типа ``reply`` из метаинформации документооборота. В ответе метод вернет печатную форму и контент ответного документа в формате base64.
2. Сформируйте к ответному документу подпись и приложите ее к документу: :ref:`PUT ReplyDocumentSignature<rst-markup-repliSignature>`.
3. Отправьте ответный документ :ref:`POST SendReplyDocument<rst-markup-sendreply>`.

.. note:: Для некоторых типов документооборотов порядок создания и формирование ответных документов отличается, например, для :doc:`проактивных выплат</scenarios/SFR/FSS/index>` и :doc:`опись для ответа на требование</scenarios/FNS/demand/inventory>`.