.. _`Личном кабинете страхователя`: https://lk.fss.ru/
.. _`Госуслуг`: https://www.gosuslugi.ru/

Подтверждение основного вида экономической деятельности
=======================================================

Организации-страхователи отправляют подтверждение основного вида экономической деятельности (ПОВЭД) раз в год – до 15 апреля включительно. На основании полученных данных СФР определяет тариф страховых взносов на страхование от несчастных случаев на производстве и профзаболеваний.

Через API Контур.Экстерн можно отправить документы в СФР (тип документооборота urn:docflow:fss-sedo-oved-confirmation) и получить результаты обработки Фондом. Информацию об установленной ставке можно узнать в `Личном кабинете страхователя`_ или на сайте `Госуслуг`_ в течение 2 недель с момента отправки.

Документооборот ПОВЭД включает в себя несколько :ref:`типов сообщений<rst-markup-type_messages_sedo_POVED>`:

* 15 — Заявление на подтверждение основного вида экономической деятельности.
* 16 — Уведомлние об изменении статуса на подтверждение основного вида экономической деятельности.
* 31 — Уведомление о размере страховых взносов юридического лица.

**Особенности документооборота**

* Все отправляемые документы являются SOAP-запросами.
* Запросы должны быть подписаны подписью в формате :doc:`XMLDsig</manuals/xmldsig>`.
* Уведомление о размере страховых взносов юридического лица поступает отдельным документом urn:document:fss-sedo-oved-confirmation-insurance-premiums-amount-notification-document.
* На одно отправленное заявление на ПОВЭД может поступить несколько Уведомлений об изменении статуса на ПОВЭД.

Отправка ПОВЭД
--------------
.. warning:: С 1 ноября 2024 года СФР не принимает отчетность с регистрационным номером ФСС. ПОВЭД необходимо запрашивать с единым регистрационным номером (ЕРН). 
    
    В API Контур.Экстерна укажите ЕРН в поле ``registration-number-sfr``.

1. Создайте черновик: :ref:`POST Create draft<rst-markup-createdraft>`. При создании черновика в теле запроса обязательно укажите:

    * в ``payer`` параметр ``registration-number-sfr``;
    * в ``recipient`` параметр ``fss-code``;
    * в ``additional-info`` параметр ``machine-readable-warrant-id`` – укажите идентификатор машиночиамой доверенности, если отправляете отчет через уполномоченного представителя.

2. Загрузите файл документа в :ref:`Сервис контентов<rst-markup-load>`.
3. Создайте документ в черновике: :ref:`POST Add Document<rst-markup-addDocument>`. При создании укажите ссылку на документ в виде идентификатора из Сервиса контентов.
4. Возьмите идентификатор контента для подписания из метаинформации ответа метода ``Add Document`` в поле ``data-to-sign-content-id`` и получите данные через :ref:`Сервис контентов<rst-markup-load>`.
5. Подпишите эти данные необработанной (raw) подписью.
6. Приложите подпись к документу: :ref:`POST Add signature<rst-markup-AddSignature>`.
7. Запустите последовательность методов: :ref:`POST Check<rst-markup-check>` -> :ref:`POST Prepare<rst-markup-prepare>` -> :ref:`POST Send<rst-markup-send>`, когда черновик будет готов. Укажите для каждого метода флаг ``deferred = true`` для отложенного выполнения задач.
8. Проверьте статус выполнения задач для методов ``Check``, ``Prepare``, ``Send``: :ref:`GET DraftTask<rst-markup-DraftTasks>`. Если задача по методу ``Send`` завершился успешно, то в ответе вернется информация о созданном документообороте (ДО).

Получение результата обработки ПОВЭД
------------------------------------

Работа с отправленным документооборотом состоит из трех этапов:

1. Получение документооборота.
2. Отправка запроса на получение входящих документов от СФР.
3. Отправка отметки о прочтении на поступившие документы от СФР.

Статусы и порядок документооборота смотрите в :ref:`спецификации<rst-markup_fss-sedo-oved-confirmation>`. 

Получение документооборота
++++++++++++++++++++++++++

Для получения результат обработки найдите документооборот:

1. Запросите документооборот по его идентификатору ``docflowId``: :ref:`GET Docflow<rst-markup-get-dc>`.
2. Если идентификатор ``docflowId`` был утерян или неизвестен, то запросите список всех документооборотов учетной записи: :ref:`GET Docflows<rst-markup-get-dcs>`. В запросе укажите фильтр ``type = urn:docflow:fss-sedo-oved-confirmation``.

Запрашивайте документооборот и проверяйте статус до тех пор, пока он не станет **succesful**. Проверить статус можно в параметре ``success-state``.

Отправка запроса на получение входящих документов от СФР
++++++++++++++++++++++++++++++++++++++++++++++++++++++++

Для получения документов от СФР необходимо сформировать, подписать и отправить запрос на получение входящих документов. Для этого используйте методы генерации запроса в СФР:

1. Создайте запрос на получение документов от СФР: :ref:`POST GenerateDocumentsRequest<rst-markup-sedo>`. В запросе укажите ``docflowId`` отправленного документооборота. В ответе метод вернет шаблон запроса и хэш для подписи.
2. Подпишите хэш, который вернется в параметре ``DataToSign`` в формате byte[].
3. Добавьте необработанную подпись к запросу: :ref:`PUT SaveDocumentsRequestSignature<rst-markup-sedosavedocuments>`.
4. Отправьте запрос на получение документов в СФР: :ref:`POST SendDocumentsRequest<rst-markup-sedosavedocuments>`.

Результат обработки ПОВЭД поступит в виде документа  urn:document:fss-sedo-oved-confirmation-result-document в отправленном документообороте. 

Отправка отметки о прочтении на поступившие документы от СФР
++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++

Нужно отправить отметку о прочтении на поступившие документы от СФР. 

1. Найдите в поле ``documents`` полученного ДО документ urn:document:fss-sedo-oved-confirmation-result-document.

2. Чтобы получить файл документа, возьмите идентификатор ``content-id`` в метаинформации документа, в модели ``docflow-document-contents`` и скачайте документ из :ref:`Сервиса контентов<rst-markup-dowload>`.

3. Создайте ответный документ «Отметка о прочтении» к полученным документам. Это можно сделать несколькими способами:

    a. Сгенерирйте ответный документ: :ref:`POST CreateReplyDocument<rst-markup-post-reply-doc>`. Используйте идентификатор найденного документа для поля ``documentId``. Укажите в поле ``documentType`` тип документа для нужного ДО из таблицы ниже.
    b. Перейдите по ссылке из поля ``links`` в параметре ``rel``, содержащей тип нужного ответного документа. 

    Тип ответного документа для генерации отметки о прочтении urn:document:fss-sedo-oved-confirmation-read-receipt.

Подписывать «Отметку о прочтении» не нужно.

4. Отправьте ответный документ: :ref:`POST SendReplyDocument<rst-markup-sendreply>`. После отправки отметки о прочтении статус документооборота поменяется на **finished**.
