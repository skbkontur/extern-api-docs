.. _`29.12.2022 N ЕД-7-19/1295@`: https://normativ.kontur.ru/document?moduleId=1&documentId=456951 

Сверка с ФНС
============

Через API Контур.Экстерна можно отправлять запросы на предоставление информационных услуг в ИФНС. Сверка с ФНС осуществляется в соответствии с Приказом ФНС от `29.12.2022 N ЕД-7-19/1295@`_.

Запросить можно следующие документы:

.. warning:: С 1 января 2023 ФНС перестала принимать следующие ИОН запросы:
    
    * Справка о состоянии расчетов по налогам, сборам, пеням и штрафам (Форма N39-1).
    * Выписка операций по расчетам с бюджетом.

* Перечень налоговых деклараций (расчетов) и бухгалтерской отчетности.
    Представлен перечень форм отчетности, представленной в отчетном году. Если отчет есть в перечне, значит он принят.
* Акт сверки принадлежности сумм денежных средств.
    Содержит подробную информацию по каждому из запрашиваемых налогов о суммах платежей, задолженностей, штрафов. Позволяет увидеть сальдо на начало проверяемого периода. Рекомендуем запрашивать вместо Акта сверки расчетов по налогам, сборам, пеням и штарфам. 
* Справка об исполнении налогоплательщиком обязанности по уплате налогов, сборов, пеней, штрафов.
    Содержит информацию в целом по организации о наличии неисполненных обязанностей по данным всех инспекций ФНС. Справка приходит на дату формирования справки в налоговой, в связи с обновлением формата этот вид сверки  больше нельзя запросить на конкретную дату.
* Справка о принадлежности сумм денежных средств, перечисленных в качестве единого налогового платежа.
    Содержит информацию о том, на какие платежи распределены деньги с ЕНС. Рекомендуем запрашивать вместо Справки о состоянии расчетов.
* Справка о наличии по состоянию на дату формирования справки сальдо единого налогового счета налогоплательщика.
    Содержит информацию о разнице между суммой ЕНП и совокупной обязанностью, т.е. теми платежами, которые на данные момент налогоплательщик должен уплатить в бюджет. Рекомендуем запрашивать вместо Выписки операции по расчетам с бюджетом.
* Сведения о наличии (отсутствии) задолженности в размере отрицательного сальдо ЕНС. 
    Содержит информацию о наличии неисполненной обязанности, входящей в состав ЕНП.
* Справка о принадлежности сумм денежных средств, перечисленных в качестве единого налогового платежа (агрегированные данные).
    Содержит совокупную информацию, на какие платежи распределены деньги с ЕНС. Данные показаны общей суммой по каждому налогу за день.

Сроки ответа
------------

ИФНС предоставляет ответ на запрос на сверку в течение 5 рабочих дней с момента его отправки. На запрос справки об исполнении налогоплательщиком обязанности по уплате налогов, сборов, пеней, штрафов ответ поступает в течение 10 рабочих дней с момента отправки запроса.

Отправка запроса сверки с ФНС
-----------------------------

Запрос на предоставление информационный услуг в ИФНС можно передать через API Конутр.Экстерна, тип документооборота urn:docflow:fns534-ion. Статусы и порядок документооборота описаны в :ref:`спецификации<rst-markup-fns534-ion>`.

Можно отправить готовый файл запроса, либо создать его в с помощью методов генерации файлов в черновике.

Отправка готового файла
+++++++++++++++++++++++

1. Создайте черновик: :ref:`POST Create draft<rst-markup-createdraft>`. В метаинформации укажите:

    * ``payer`` — сведения о налогоплательщике или организации, за которую отправляется отчетность;
    * ``sender`` — отправитель или организация, которая общается с КО, отправляет и получает документы;
    * ``recipeint`` — сведения о получателе документооборота, то есть о контролирующем органе;
    * ``machine-readable-warrant-id`` — идентификатор машиночитаемой доверенности, если сверку запрашивает уполномоченный представитель.
    
        Метод вернет идентификатор черновика ``draftId``, метаинформацию черновика и ссылки для работы с ним.

2. Загрузите файл отчета и приложения к нему в :ref:`Сервис контентов<rst-markup-load>`. В ответ метод загрузки вернет идентификатор загруженного контента ``content-id``.
3. Создайте для каждого файла отдельный документ в черновике: :ref:`POST Add Document<rst-markup-addDocument>`. Укажите идентификатор контента в параметре ``content-id``.
4. Проверьте документы: :ref:`POST Check<rst-markup-check>`.
5. Добавьте подпись к документам: :ref:`POST Add signature<rst-markup-AddSignature>`.
6. Запустите последовательность методов, когда черновик будет готов: :ref:`POST Check<rst-markup-check>` -> :ref:`POST Prepare<rst-markup-prepare>` -> :ref:`POST Send<rst-markup-send>`. Укажите флаг ``deferred = true`` для отложенного выполнения задач.
7. Проверьте статус выполнения задач для методов ``Check``, ``Prepare``, ``Send``: :ref:`GET DraftTask<rst-markup-DraftTasks>`. Если задача по методу ``Send`` завершилась успешно, то в ответе вернется информация о созданном документообороте.

Создание файла в черновике по контракту
+++++++++++++++++++++++++++++++++++++++

Если нет файла запроса, его можно сгенерировать в черновике по :ref:`контракту<rst-markup-contracts-fns534-ion>`. Алгоритм работы с черновиком будет следующий:

1. Создайте черновик: :ref:`POST Create draft<rst-markup-createdraft>`.
2. Создайте документ в черновике по json контракту: :ref:`POST BuildDocumentContent<rst_markup_BuildDocumentContent>`. В запросе укажите следующие параметры:

    * ``type`` — тип ИОН-запроса;
    * ``version`` — версию документа. Для ИОН запросов это будет версия 3. 

        В Request Body передайте контракт в формате валидного JSON.

3. Добавьте подпись: :ref:`POST Add signature<rst-markup-AddSignature>`.
4. Запустите последовательность методов, когда черновик будет готов: :ref:`POST Check<rst-markup-check>` -> :ref:`POST Prepare<rst-markup-prepare>` -> :ref:`POST Send<rst-markup-send>`. Укажите флаг ``deferred = true`` для отложенного выполнения задач.
5. Проверьте статус выполнения задач для методов ``Check``, ``Prepare``, ``Send``: :ref:`GET DraftTask<rst-markup-DraftTasks>`. Если задача по методу ``Send`` завершилась успешно, то в ответе вернется информация о созданном документообороте.